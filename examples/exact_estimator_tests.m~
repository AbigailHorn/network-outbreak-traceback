% Example code

addpath('../utility'); % allow access to the other code

% Create small, simple network. 6 nodes per stage, each with in/out deg = 4.

% % Set parameters
% avg_deg = 2; 
% node_counts = [6 6 6 6]; % formerly n1
% init_vol_dist = 'bin';
% network_params = cell(3, 4);
% network_params(1, :) = {avg_deg, 'out', 'bin', 'bin'};
% network_params(2, :) = {avg_deg, 'out', 'bin', 'bin'};
% network_params(3, :) = {avg_deg, 'out', 'bin', 'bin'};
% show_plots = true;
% display_network = true;
% 
% % Create network linkages
% [flows, node_layers, init_vols, stage_ends] = random_layered_graph(node_counts, init_vol_dist, ...
%     network_params, show_plots, display_network);
% % Assign network locations
% show_loc_plots = true;
% [node_data, dists, node_locs] = assign_locations(node_layers, flows, show_loc_plots);
% 
% % Simulate outbreak...deterministically!
% dispersion = 'max';
% src_farm = 1;
% num_stages = 4;
% return_all_reports = true;
% plot_or_not = true;
% transport_dev_frac = 0; % this is what makes it deterministic
% storage_is_determ = true; % and this
% 
% [contam_farm, contam_retailers] = outbreak(dispersion, src_farm, dists, ...
%     node_locs, flows, init_vols, num_stages, return_all_reports, ...
%     plot_or_not, transport_dev_frac, storage_is_determ);
% 
% % additional parameters necessary for traceback
% contam_observed_nodes = contam_retailers;
% distances = dists;
% P = 0.9;
% include_volumes = true;






% preserved from an earlier run that ran in a reasonable amount of time. 
% If you're feeling brave, try generating your own!
tractable_flows = [0,0,0,0,0,0,0.500000000000000,0,0,0.500000000000000,0,0,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0.500000000000000,0,0,0.500000000000000,0,0,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0.351400000000000,0,0.270300000000000,0.378400000000000,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0.631600000000000,0,0.368400000000000,0,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0.444400000000000,0,0,0,0,0.555600000000000,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0.476200000000000,0,0.523800000000000,0,0,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.636400000000000,0.363600000000000,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0.297300000000000,0,0,0.351400000000000,0.351400000000000,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0.393900000000000,0.333300000000000,0,0,0.272700000000000,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.409100000000000,0.590900000000000,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0.222200000000000,0.244400000000000,0.288900000000000,0,0,0.244400000000000,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.450000000000000,0,0,0.550000000000000,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.521700000000000,0.478300000000000;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.523800000000000,0.476200000000000,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.571400000000000,0.428600000000000,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];
tractable_distances = [0,0,0,0,0,0,550.568695885345,0,0,513.932658796634,0,0,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,453.960595450995,0,0,344.821370825211,0,0,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,248.709670097485,0,248.709670097485,101.303997946774,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,248.709670097485,0,248.709670097485,0,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,978.948018141016,0,0,0,0,101.303997946774,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,840.228606458451,0,0,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,258.327096698912,750.991659222805,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,348.539811212435,0,0,614.414355301046,103.533810902526,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,909.945740140587,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,954.039365598250,517.937844833829,0,0,181.049793641909,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,512.085197989553,909.945740140587,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,463.046973859024,870.517374898399,813.182021444154,0,0,1006.14275826048,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,744.548856691084,0,0,744.548856691084,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,460.795507790603,460.795507790603;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,418.885724273339,418.885724273339,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,396.011679120705,396.011679120705,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];
tractable_contam_reports = [24,24,24,24,24,24,24,24,24,24,24,24,24,22,22,22,22,22,23,23,23,23,23,24,24,24,24,24,19,19,24,24,24,24,20,20,20,20,20,22,22,24,24,24,24,23,23,23,23,23,23,23,24,24,24,19,19,24,24,24,19,19,24,24,21,21,20,20,20,20,22,22,21,21,24,24,24,24,19,19,19,19,19,23,19,24,24,24,23,23,23,23,23,24,24,24,24,24,23,23,23,20,20,20,23,23,23,23,23,23,23,24,24,24,20,20,20,20,24,24,20,20,24,24,24,24,24,24,24,19,19,19,24,24,24,24,24,24,20,20,24,24;9.78396157553057,9.78396157553057,9.78396157553057,9.78396157553057,9.78396157553057,9.78396157553057,9.78396157553057,9.78396157553057,9.78396157553057,9.78396157553057,9.78396157553057,9.78396157553057,9.78396157553057,10.2317367167607,10.2317367167607,10.2317367167607,10.2317367167607,10.2317367167607,10.8693111292398,10.8693111292398,10.8693111292398,10.8301143244363,10.8301143244363,9.78396157553057,9.78396157553057,9.78396157553057,9.78396157553057,9.78396157553057,11.2308667926690,11.2308667926690,9.78396157553057,9.78396157553057,9.78396157553057,9.78396157553057,11.2308667926690,11.2308667926690,11.2308667926690,11.2308667926690,11.2308667926690,10.2317367167607,10.2317367167607,9.78396157553057,9.78396157553057,9.78396157553057,9.78396157553057,10.8301143244363,10.8301143244363,10.8301143244363,10.8301143244363,10.8301143244363,10.8693111292398,10.8693111292398,9.78396157553057,9.78396157553057,9.78396157553057,11.2308667926690,11.2308667926690,9.78396157553057,9.78396157553057,9.78396157553057,11.2308667926690,11.2308667926690,10.8693111292398,10.8693111292398,10.2317367167607,10.2317367167607,11.2308667926690,11.2308667926690,11.2308667926690,11.2308667926690,10.2317367167607,10.2317367167607,10.2317367167607,10.2317367167607,9.78396157553057,9.78396157553057,9.78396157553057,9.78396157553057,11.2308667926690,11.2308667926690,11.2308667926690,11.2308667926690,11.2308667926690,10.8693111292398,11.2308667926690,9.78396157553057,9.78396157553057,9.78396157553057,10.8301143244363,10.8301143244363,10.8301143244363,10.8301143244363,10.8301143244363,9.78396157553057,9.78396157553057,9.78396157553057,9.78396157553057,9.78396157553057,10.8301143244363,10.8301143244363,10.8301143244363,11.2308667926690,11.2308667926690,11.2308667926690,10.8301143244363,10.8301143244363,10.8301143244363,10.8301143244363,10.8301143244363,10.8301143244363,10.8301143244363,9.78396157553057,9.78396157553057,9.78396157553057,11.2308667926690,11.2308667926690,11.2308667926690,11.2308667926690,9.78396157553057,9.78396157553057,11.2308667926690,11.2308667926690,9.78396157553057,9.78396157553057,9.78396157553057,9.78396157553057,9.78396157553057,9.78396157553057,9.78396157553057,11.2308667926690,11.2308667926690,11.2308667926690,9.78396157553057,9.78396157553057,9.78396157553057,9.78396157553057,9.78396157553057,9.78396157553057,11.2308667926690,11.2308667926690,9.78396157553057,9.78396157553057;5.78396157553057,5.78396157553057,5.78396157553057,5.78396157553057,5.78396157553057,5.78396157553057,5.78396157553057,5.78396157553057,5.78396157553057,5.78396157553057,5.78396157553057,5.78396157553057,5.78396157553057,6.23173671676071,6.23173671676071,6.23173671676071,6.23173671676071,6.23173671676071,6.86931112923979,6.86931112923979,6.86931112923979,6.83011432443632,6.83011432443632,5.78396157553057,5.78396157553057,5.78396157553057,5.78396157553057,5.78396157553057,7.23086679266903,7.23086679266903,5.78396157553057,5.78396157553057,5.78396157553057,5.78396157553057,7.23086679266903,7.23086679266903,7.23086679266903,7.23086679266903,7.23086679266903,6.23173671676071,6.23173671676071,5.78396157553057,5.78396157553057,5.78396157553057,5.78396157553057,6.83011432443632,6.83011432443632,6.83011432443632,6.83011432443632,6.83011432443632,6.86931112923979,6.86931112923979,5.78396157553057,5.78396157553057,5.78396157553057,7.23086679266903,7.23086679266903,5.78396157553057,5.78396157553057,5.78396157553057,7.23086679266903,7.23086679266903,6.86931112923979,6.86931112923979,6.23173671676071,6.23173671676071,7.23086679266903,7.23086679266903,7.23086679266903,7.23086679266903,6.23173671676071,6.23173671676071,6.23173671676071,6.23173671676071,5.78396157553057,5.78396157553057,5.78396157553057,5.78396157553057,7.23086679266903,7.23086679266903,7.23086679266903,7.23086679266903,7.23086679266903,6.86931112923979,7.23086679266903,5.78396157553057,5.78396157553057,5.78396157553057,6.83011432443632,6.83011432443632,6.83011432443632,6.83011432443632,6.83011432443632,5.78396157553057,5.78396157553057,5.78396157553057,5.78396157553057,5.78396157553057,6.83011432443632,6.83011432443632,6.83011432443632,7.23086679266903,7.23086679266903,7.23086679266903,6.83011432443632,6.83011432443632,6.83011432443632,6.83011432443632,6.83011432443632,6.83011432443632,6.83011432443632,5.78396157553057,5.78396157553057,5.78396157553057,7.23086679266903,7.23086679266903,7.23086679266903,7.23086679266903,5.78396157553057,5.78396157553057,7.23086679266903,7.23086679266903,5.78396157553057,5.78396157553057,5.78396157553057,5.78396157553057,5.78396157553057,5.78396157553057,5.78396157553057,7.23086679266903,7.23086679266903,7.23086679266903,5.78396157553057,5.78396157553057,5.78396157553057,5.78396157553057,5.78396157553057,5.78396157553057,7.23086679266903,7.23086679266903,5.78396157553057,5.78396157553057];
tractable_stage_ends = [6 12 18 24];
tractable_init_vols = [0.129000000000000,0.145200000000000,0.177400000000000,0.209700000000000,0.177400000000000,0.161300000000000];
P = .9;
transport_dev_frac = 0; % this was a deterministic outbreak


% Restrict the size of contam_reports to 10 reports (a number that exact estimator usually achieves
% reasonable runtime for on this graph)
skip_num = floor(length(contam_retailers)/25); % this will take like 10min to run. Decrease the number to go faster.

exact_methods = 1:3;

summary_stats = zeros([3, stage_ends(1)+2]);
summary_stats(:, 1) = 1:3; % first col is method id, second is t_s_star, remaining cols are pmf


% Run this on the tractable stats
for method_id = exact_methods
    tractable_init_vols
    [pmf, t_s_stars] = time_traceback(method_id, tractable_flows, tractable_stage_ends, ...
        tractable_init_vols, tractable_contam_reports(:,1:skip_num:end), ...
        tractable_distances, P, transport_dev_frac);
    summary_stats(method_id, 2) = t_s_stars(1);
    summary_stats(method_id, 3:end) = pmf;
end

'Printing summary statistics from all tracebacks...'
'[Method_ID    t_s_star_1    [pmf ...]]'

summary_stats

% useful output to screen
'actual source'
contam_farm
length(contam_retailers)