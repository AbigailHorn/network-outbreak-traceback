% Example code: compare performance of heuristic and exact estimators on a
% tractable outbreak case.

addpath('../utility'); % allow access to the other code

% This network/outbreak pair was empirically shown to lead to tractable exact-estimator evaluations
% (On a restricted set of contam_reports)
tractable_flows = [0,0,0,0,0,0,0.458300000000000,0.541700000000000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0.571400000000000,0.428600000000000,0,0,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0.608700000000000,0.391300000000000,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0.523800000000000,0.476200000000000,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0.636400000000000,0.363600000000000,0,0,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0.590900000000000,0.409100000000000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0.500000000000000,0.500000000000000,0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.608700000000000,0.391300000000000,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.541700000000000,0.458300000000000,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.500000000000000,0.500000000000000,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.700000000000000,0.300000000000000,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0.450000000000000,0.550000000000000,0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.523800000000000,0.476200000000000,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.500000000000000,0.500000000000000,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.555600000000000,0.444400000000000;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.578900000000000,0.421100000000000;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.520000000000000,0.480000000000000,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.578900000000000,0.421100000000000,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];
tractable_distances = [0,0,0,0,0,0,667.046662535688,667.046662535688,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,698.242973469837,698.242973469837,0,0,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,893.599742614108,893.599742614108,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,893.599742614108,893.599742614108,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,698.242973469837,698.242973469837,0,0,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,667.046662535688,667.046662535688,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,723.769645674644,725.629726513461,0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,1006.43057385992,1006.43057385992,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,182.976774482446,569.514266722090,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,182.976774482446,569.514266722090,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,1197.59394203545,1197.59394203545,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,452.030142800234,873.554949616794,0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,918.622474142670,918.622474142670,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,476.817837334133,476.817837334133,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,247.500000000000,247.500000000000;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,247.500000000000,247.500000000000;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,476.817837334133,476.817837334133,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,918.622474142670,918.622474142670,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];
tractable_contam_reports = [23,23,22,22,22,21,21,21,23,23,21,21,21,21,21,24,24,24,24,24,21,21,21,21,21,21,21,21,21,21,22,22,24,24,24,24,24,24,23,19,19,22,22,22,22,23,23,23,23,23,20,20,20,19,19,19,23,24,24,24,24,19,19,19,19,19,19,19,24,24,24,23,23,23,23,21,20,24,24,24,24,24,24,21,21,20,20,20,20,20,20,20,20,20,23,23,23,22,23,23,21,21,21,21,21,21,21,21,21,24,24,24,23,23,23,24,24,24,24,24,24,24,23,23,23,20,20,20,19,19,19,19,19,22,23,23,23,23,23,24,24,24,24,20,20,23,23,23,22,22,19,19,19,22,22,22,23,20,20,20,20,21,23,23,23,23,23,23,23,21,24,24,24,24,21,21,21,21,20,20,20,19,19,19,19,19,19,19,24;11.7576882397431,8.34519787357077,14.3056707216319,16.0497721068024,22.0550175415229,9.90228623754041,11.7233419186198,17.1628738683609,16.0336519058427,11.2191216633166,10.2551375714842,15.8462371357136,9.85290947405074,13.1549870870570,9.71683331321702,9.24608517644531,16.2262663291485,10.8821680121130,12.8174418288640,16.5279366430767,16.0870292265954,10.8834574422229,8.78783994552388,9.02339266394082,10.1184832033856,15.8304935202130,9.06255302225726,7.82678162724885,15.3924606054442,11.2306344403146,10.6741275562349,10.7229254965377,7.98920794687500,19.9322738923560,13.9633434973828,9.02961496616842,14.4722387553733,10.7913757311248,9.69992752871677,8.48705308671086,20.4415223016488,10.5067196588210,10.1533104892812,8.27469006070418,14.1526937403082,9.52988465498886,14.9698657166555,12.5975281473881,12.0214003262628,18.4789354300033,9.92895595083912,11.8969085274430,14.5446197230639,11.9688570328993,6.68501442527333,11.2889920516100,10.1933167108520,8.69511774690838,14.4310797277375,10.7477702410956,8.70545195087362,22.5915780635596,8.70958179318845,8.98803147617026,8.89952088939164,12.4903836961706,11.3085464803852,8.99008014413699,8.15442010915051,9.88310885340503,10.3792032758441,14.0792779025367,10.6276779592396,12.4411715980205,14.0718183832862,16.6899872851896,10.4963865625769,12.0152924694535,10.5925941552119,14.3411237964898,15.3771747982846,12.5983973004982,7.98726374903646,10.2498391061207,16.1248683173468,8.43819975333654,8.60323184235488,7.50240955651387,10.3898463340543,8.08487755583455,10.3277770457626,9.67688743457946,12.2084290736199,9.15697041272804,9.63956985914320,9.84416836957623,9.16738136849037,9.32883401678364,11.5273663150392,11.1252192557335,9.69243908244224,22.4346376367009,12.3383027365178,11.4308775316394,17.3792656671228,9.78891348390725,8.86854512676988,15.7220321414152,13.0382038223240,8.42188543938564,21.2961859465092,8.93352655947292,6.63603554916256,15.8911659919501,6.57975909715193,8.93799296226885,9.86610463977935,9.84143029384229,11.0619556871273,8.93542060847323,10.0811310114189,9.96324385266905,12.7291407801008,10.4308963963693,13.5737784749786,13.4064983455021,16.1167232620753,9.09523173103653,10.3047130208518,9.38714441493320,10.8078356995966,9.72929967909523,8.55147079740858,10.0525414659853,14.3535362858912,12.1496658090754,18.2228473762581,13.1695781513187,8.12651777822230,13.2027168107010,15.6378478923895,8.69646526539856,13.2433341900383,19.5012812031656,17.9937029445786,11.4454257281145,9.78060428019624,13.2231287572001,13.9519075797018,9.54775601089834,12.6551229651869,8.78194277443513,16.6863395427990,9.75896868850704,11.4893085159945,16.1851206046930,9.93921409368628,12.4097890220748,7.54462085710659,11.4243635194694,19.2504104945393,13.3386024078024,9.97402463493812,8.20684322269100,8.32669095747675,8.67489901216958,8.77195746572068,12.3129561897191,7.90107605194538,30.6969849565530,14.2167152844304,16.3514679713134,9.63703736200613,9.40264525363044,14.4487689558762,11.4937202623644,9.46406403403567,9.00313571231806,8.88568155220022,9.07701323784905,14.2909132961020,8.61930573722947,8.69702151808749,13.7640431915246,11.1988737846156,11.0175658526440,8.64951388068144,17.0900418677896,13.9907739674440;9.46033394231180,3.77684442974735,11.0141330668402,11.1989554877809,17.1998748131421,6.01881676613571,6.14356585898596,13.0530270359225,13.1356217579848,6.71953524580820,6.95738574377121,10.9435059523625,5.94715148831885,9.04613330972518,5.15981589707450,5.66477085456233,11.1778698925611,7.43299787686675,8.16936160812213,13.3172064997456,13.3561657268366,5.24671659163467,5.28204369719422,4.36009616116791,6.66107893857153,11.5419373148279,5.50949897060848,3.83950558458916,10.6644328789953,7.14426897787917,4.39420218202534,6.04578715535703,5.42092982327315,13.8073597176040,12.7507454949220,4.47496185826468,10.6734888260294,7.29768372898833,4.55538296312851,4.50551724107509,15.7066241138070,5.82790722626616,5.85851168839706,4.88126575948164,10.2719732580467,5.72820851694371,10.9542850545208,7.10190309983257,7.23638917471664,15.2615519252304,6.13045693556525,7.47790261009255,10.3955251310958,7.49735566616151,4.41465751397594,6.70257970843114,6.59074200559369,5.81869922853404,10.1293693208406,6.39825810169467,3.91033257047303,19.8860998783320,5.73578885238860,5.45867737239639,4.87883677909663,8.14233176227547,7.70259560479036,5.22685052817312,3.69619742119855,4.46721275041739,6.08384229339179,9.70012052292504,5.75523187643656,10.1965549566665,9.65754957577116,11.9055085373702,5.37404029848789,5.99999743412946,6.60210030939788,10.3956990436915,9.57904862236456,8.66041633339877,3.75501586432572,7.23405737239054,11.7292139658124,4.03895772379701,4.19894880264445,3.94253408389665,6.80317601746831,5.96700141490304,6.64924783809754,6.43391663214544,8.77434907886846,6.08602472451466,5.29907763621340,6.73213416788663,4.65666050895555,5.20152304706377,7.70637667132658,7.22742972191963,6.08226664965128,18.4745336725740,8.04468021045627,7.23943250753225,11.7077515288202,5.96535912073741,4.51280813921417,10.6859554020339,9.44952399497289,4.35299188828155,17.2703214487428,5.12222819688208,3.87925784165334,11.9813417164630,2.99514749790368,5.88492756052787,7.12631377837104,4.13786921915885,7.47569737357924,4.45659595092444,4.80364975974655,6.14418990410968,8.51250934961523,5.57543318554833,10.8381487367027,8.90520156310757,13.0727072591202,5.18261223860728,6.99622402087820,4.91838972628969,5.92364350972378,5.58963443412172,4.33846198803740,7.41657829564345,10.1860203628609,6.32129971128195,13.7802935472632,9.49033359034389,4.73027029656266,8.38295618231759,10.8887677376941,6.01810924096054,6.99273977185236,15.2548164050330,13.2597346844274,8.76323320354396,5.71684260484771,8.51821446712724,9.00616395636891,6.27482717966265,8.10626451072969,3.69269041746018,12.0144869169942,5.91986620425377,6.51065692513118,12.6316805132392,5.76038136008977,9.95433261612495,4.23271897660690,7.09297511631323,14.8667242696652,8.56025770231203,5.31650554194933,4.23044374128445,4.52039159263317,4.48742475112378,4.63663000049770,6.02915661321816,4.53782293085847,24.6089565824542,9.91229860316320,12.7386943097075,4.82947540548153,5.74328275664042,11.5181816275137,7.82614527594046,4.48159593925449,7.67854599732886,4.78312876059608,4.71418102710746,10.0210279915019,5.69515324025402,5.35219650671818,8.28317770287517,6.96570705255343,6.60249764179370,5.62751604807595,12.0429733589595,10.4081659071050];
tractable_stage_ends = [6 12 18 24];
tractable_init_vols = [0.169200000000000,0.138500000000000,0.184600000000000,0.184600000000000,0.184600000000000,0.138500000000000];
tractable_num_stages = 4;
P = 0.9;
transport_dev_frac = 0.1; % this was a deterministic outbreak



% % UNCOMMENT THIS IF you want to re-run a different oubreak on the saved graph.
% % (leaving it commented will use the saved outbreak instead)
% tractable_node_locs = cell([4, 1]);
% tractable_node_locs{1, 1} = [1477,224;1039,313;249,1417;1968,928;2196,1095;634,1258];
% tractable_node_locs{2, 1} = [1055.50000000000,741;1055.50000000000,741;1617.50000000000,704;1617.50000000000,704;1108.50000000000,1172.50000000000;1108.50000000000,1172.50000000000];
% tractable_node_locs{3, 1} = [1550,1269.50000000000;1767,598.500000000000;1986,357.500000000000;1986,357.500000000000;1767,598.500000000000;1550,1269.50000000000];
% tractable_node_locs{4, 1} = [635,1351;2465,1188;1972,168;1562,1029;2184,506;1788,209];
% dispersion = 'max';
% src_farm = 1;
% return_all_reports = true;
% plot_or_not = false;
% storage_is_determ = false;
% [contam_farm, tractable_contam_reports] = outbreak(dispersion, src_farm, tractable_distances, ...
%     tractable_node_locs, tractable_flows, tractable_init_vols, tractable_num_stages, ...
%     return_all_reports, plot_or_not, transport_dev_frac, storage_is_determ);



% Restrict the size of contam_reports to 19 reports (a number that exact estimator usually achieves
% reasonable runtime for this graph)
skip_num = floor(length(tractable_contam_reports)/19); % this will take like 3min to run. Decrease the number to go faster.

all_methods = 1:11;
summary_stats = zeros([11, tractable_stage_ends(1)+2]);
summary_stats(:, 1) = 1:11; % first col is method id, second is t_s_star, remaining cols are pmf

% Run all traceback methods
for method_id = all_methods
    [pmf, t_s_stars] = time_traceback(method_id, tractable_flows, tractable_stage_ends, ...
        tractable_init_vols, tractable_contam_reports(:,1:skip_num:end), ...
        tractable_distances, P, transport_dev_frac);
    summary_stats(method_id, 2) = t_s_stars(1);
    summary_stats(method_id, 3:end) = pmf;
end

% useful output to screen
'Printing summary statistics from all tracebacks...'
'[Method_ID    t_s_star_1    [pmf ...]]'
summary_stats

'actual source'
contam_farm
